#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1

start_service() {
    config_load tailscale

    local enabled
    config_get_bool enabled config enabled 0
    [ "$enabled" -eq 0 ] && return 0

    local port
    config_get port config port 41641

    local log_level
    config_get log_level config log_level ""

    local extra_args
    config_get extra_args config extra_args ""

    # Create directories with appropriate permissions
    mkdir -p /var/run/tailscale
    mkdir -p /var/lib/tailscale
    chmod 700 /var/lib/tailscale

    procd_open_instance
    procd_set_param command /usr/sbin/tailscaled
    procd_append_param command --port "$port"
    procd_append_param command --statedir /var/lib/tailscale
    procd_append_param command --socket /var/run/tailscale/tailscaled.sock

    # Memory optimization for 64MB RAM device - disable telemetry/logging
    procd_append_param command --no-logs-no-support

    [ -n "$log_level" ] && procd_append_param command --verbose="$log_level"

    # Handle extra_args safely (word splitting intentional for multiple args)
    if [ -n "$extra_args" ]; then
        for arg in $extra_args; do
            procd_append_param command "$arg"
        done
    fi

    # Aggressive memory tuning for 64MB RAM device
    procd_set_param env GOGC=50
    procd_set_param env GOMEMLIMIT=50MiB

    procd_set_param respawn 3600 5 5
    procd_set_param file /etc/config/tailscale

    # Disable logging to save memory on constrained device
    procd_set_param stdout 0
    procd_set_param stderr 0
    procd_close_instance
}

reload_service() {
    stop
    start
}

service_stopped() {
    rm -f /var/run/tailscale/tailscaled.sock
}

service_triggers() {
    procd_add_reload_trigger "tailscale"

    # Reload when network interfaces change (important for 5G/LTE routers)
    procd_add_reload_interface_trigger "wan"
    procd_add_reload_interface_trigger "wwan"
    procd_add_reload_interface_trigger "wwan0"
}
