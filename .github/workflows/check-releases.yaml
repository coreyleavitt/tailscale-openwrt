name: Check for New Tailscale Releases

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Get latest Tailscale release
        id: tailscale
        run: |
          LATEST=$(curl -s https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r .tag_name)
          # Strip 'v' prefix for version number
          VERSION="${LATEST#v}"
          echo "tag=$LATEST" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest Tailscale release: $LATEST (version: $VERSION)"

      - name: Check if we have a release for this version
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tailscale.outputs.tag }}"
          # Check if release exists in our repo
          if gh release view "$TAG" --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "Already have release for $TAG"
            echo "needs_build=false" >> $GITHUB_OUTPUT
          else
            echo "No release found for $TAG - triggering build"
            echo "needs_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger build workflow
        if: steps.check.outputs.needs_build == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.tailscale.outputs.version }}"
          echo "Triggering build for Tailscale $VERSION"
          gh workflow run build-tailscale.yaml \
            --repo ${{ github.repository }} \
            -f tailscale_version="$VERSION" \
            -f pkg_release="1"
